This file contains my requirements for AI copilot, please never update this file.

General overview:
    - you should create web site for flask/python that will be hosted in Google "Cloud Run" using /dockerfile
    - Add files for SEO, metadata, and keys for best search appearence
    - We are creating a web site about Gems, a hub with all related information
    - See my other web sites in https://github.com/BusyStas/stasclub and https://github.com/BusyStas/stasboston
    - I promote "Defensive Coding" style
    - Every page should have Google Analytics code installed from /templates/includes/google_tag.html
    - Every time you have an error or exception when you call a database, save it into logs/db_errors.log with timestamp and error description

Copilot Instructions:
    - Try avoid using command "PY" in the terminal from now on.
    - If you run tests - please put them into a single file and run all together, so that you do not ask me to approve it 500 times. 


Style and design:
    - Avoid too many colors on a screen, I prefer different shades of a color (blue or green, sometimes orange)
    - Consider shades of BLUE to be the main color scheme here
    - I like smaller fonts and condenced space between lines
    - Menu should not have borders, and no gaps between submenu pan and the main menu panel
    - Icons that you use for menu items should be one color (no multiple colors), and in the same style
    
Web Site Navigation:
    - Collapsible left column menu for navigation between pages
    - There should be "a sandwich-bar" to collapse the menu on the left, so only icons are shown
    - Some menu items will be nested
    - Inner menu items should be displayed on the right side of the main menu item when click on the parent menu
        - Inner menus should be of the same style as the main menu items
    - The menu should be consistent across all pages (use INCLUDE and keep the menu in one file)
    - Here are the sections on the menu:
        - Home
        - My Profile
        - My Portfolio
            - All Holdings (/portfolio)
            - Summary (/portfolio/stats)
            - Print Tags (/portfolio/tags)
        - Type of Gems
            - By hardness
            - By rarity
            - By aviailability
            - By size
            - By price
            - By investment appropriateness
            - By investment rankings
            - By colors
            - By brilliance
        - Stores and Auctions
            - Gem Rock Auctions
            - Best In Gems
        - Investments
        - Testing Methods (short name "Testing" for the top menu)
            - Refractive Index
            - Specific Gravity
            - Spectroscopy
                - add link to https://prettyrock.com/pages/spectroscope-instructions in "See Also"  
            - Microscopy
            - UV Fluorescence
            - Inclusion Analysis
            - Dichroscope Analysis
            - Polariscope Analysis
            - Chelsea Filter Test
        - Certification Labs (short name "Labs" for the top menu)

        - Jewelry
            - Ask Web API to list Service Types for the Asset Type AST_JEWELRY (23). there should be 1 menu item per service type

    - Every page should have 1 line navigation at the top (separated by a pipe "|"), containing top level navigation
        - the top navigation should not have "Home"
        - the top navigation should not have nested items, only top level items
        - the top navigation should have icon for "My Profile" in the right corner, to the left from "Sign In" (or Logout)
        - the top navigation should have icon for "My Portfolio" to the left from "My Profile"
        - Some menu items should be called with a short name:
            - "Type of Gems" should be called "Gems"
            - "Stores and Auctions" should be called "Auctions"
            - "Certification Labs" should be called "Labs"

Include "Disclaimer" section:
    - Every page should have a disclaimer bottom section 
    - It should contain Privacy Policy link (/privacy-policy and /privacy) 
    - It should contain Terms of Service link (/terms-of-service and /terms)
    - Indicate contact email: support@preciousstone.info 

Page "/health":
    - Not accessible from any menu, only direct URL
    - Show information about the health of the web site:
        - What api health endpoint returns
        - True/fals if the api key exists and longer than 100 characters    
        - Number of gem types returned by the API

Pages "Jewelry"/{ServiceType}:
    - List firms that provide this service type from the web api 
    - Use an endpoint that will call a sproc in GemAPI schema

Pages "Certification Labs":
    - Each page should show information about the labs
            - GIA
            - AIG
            - AGS
            - Gubelin
            - Lotus
            - IGI
            - GRS
            - AIGS
            - ICA
            - AGL
            - HRD
            - AIGL
            - HKD
            - SSEF
            - GAA
            - EGL
            - GFCO: https://www.gfcogemlab.ch/
            - GOJIOT
            - ALGT (Antwerp Laboratory for Gemstone Testing)
            - DGA    - Use information from https://www.gia.edu/gia-labs , https://www.americangemlab.com/ , https://igi.org/ , https://www.eglusa.com/
            - HGTL (Himalayan Gem Testing Lab)
    - Show schedule fee:
        - GIA: https://www.gia.edu/doc/ColoredStones_FeeSchedule_MASTER_Q3_2025_USD.pdf
        - AGS: https://www.americangemlab.com/fees/
    - Each page should have a link to the lab web site
    - Each page should have a link to the lab locations page on their web site
    - Each page should have a link to the lab services page on their web site
    - Each page should have a link to the lab pricing page on their web site (if available)

Page "Gem Rock Auctions":
    - Show list of gem types from config/config_gem_types.yaml
        - Display them as a bulleted list (not in a box)
        - Display Mineral Group and under it the Gem Types one on each line
        - Show all gem types from the config file, no search needed, no filtering needed.
    - Each gem type should be a link to search on Gem Rock Auctions site for that gem
    - Use this search URL format: https://www.gemrockauctions.com/search?query=GEMTYPE_HERE
        - both Mineral Group and Gem Type should have its own link to this store

Page "Best In Gems":
    - Show list of gem types from config/config_gem_types.yaml
        - Display them as a bulleted list (not in a box)
        - Display Mineral Group and under it the Gem Types one on each line
        - Show all gem types from the config file, no search needed, no filtering needed.
    - Each gem type should be a link to search on Best In Gems site for that gem
    - Use this search URL format: https://www.bestingems.com/listing/buy-gemstones-online/?filter=gemsname:GEMTYPE_HERE
        - both Mineral Group and Gem Type should have its own link to this store

Page "Type of Gems"/"By hardness":
    - Show list of gem types grouped by hardness from config/config_gem_types.yaml
        - Display a table with columns:
            - Gem Type (show Mineral Group when mouse hovers over Gem Type)
            - Mohs Hardness
            - Investment Ranking Tier (see those values in config/config_gem_metadata.txt) 
                - it should be a link to the gem profile page for that gem type (/gem/GEMTYPE_HERE)
        - Mineral Group is not needed to be visible in the table on this page
        - Show all gem types from the config file, no search needed, no filtering needed.
    - Each gem type should be a link to that gem profile
    - Sort by hardness level descending
    - Separate "By hardness" page into sections by hardness levels
        - Very Soft (1-2.99)
        - Soft (3-5.99)
        - Medium-1 (6-6.99)
        - Medium-2 (7.0-7.49)
        - Hard-1 (7.5-7.99)
        - Hard-2 (8.0-8.49)
        - Very Hard (8.5-10)
        - Extremely Hard (10)

Page "Type of Gems"/"By size":
    - Show list of gem types grouped by size from config/config_gem_types.yaml
        - Display a table with columns:
            - Gem Type (show Mineral Group when mouse hovers over Gem Type)
            - Typical Size
        - Mineral Group is not needed to be visible in the table on this page
        - Show all gem types from the config file, no search needed, no filtering needed.
    - Each gem type should be a link to that gem profile
    - Sort by size level descending
    - Separate "By size" page into sections by size levels
        - VERY LARGE STONES (commonly available 50+ carats)
        - LARGE STONES (commonly available 20-50 carats)
        - MEDIUM TO LARGE STONES (10-30 carats typical)
        - SMALL TO MEDIUM STONES (under 10 carats typical)
        - VERY SMALL STONES (typically under 3 carats)

Page "Type of Gems"/"By price":
    - Show list of gem types grouped by price from config/config_gem_types.yaml
        - Display a table with columns:
            - Gem Type (show Mineral Group when mouse hovers over Gem Type)
            - Typical Price from config/config_gem_pricerange.txt
        - Mineral Group is not needed to be visible in the table on this page
        - Show all gem types from the config file, no search needed, no filtering needed.
    - Each gem type should be a link to that gem profile
    - Sort by price level descending
    - Separate "By price" page into sections by price levels (consider what the highest price coudl be):
        - ULTRA-LUXURY ($50,000+ per carat)
        - SUPER-PREMIUM ($10,000-50,000 per carat)
        - PREMIUM ($1,000-10,000 per carat)
        - HIGH-END ($500-3,000 per carat)
        - MID-RANGE ($100-500 per carat)
        - AFFORDABLE ($50-200 per carat)
        - BUDGET-FRIENDLY ($5-50 per carat)

Page "Type of Gems"/"By rarity":
    - Show list of gem types grouped by rarity
    - List all gemstones from config/config_gem_types.yaml
    - group by "rarity" and Sort groups by rarity level descending
    - Display the information from the /config/config_gem_rarity.yaml file
        - Do not display the rarity itself, because it is already grouped by it
    - Display in a table with columns:
        - Gem Type (show Mineral Group when mouse hovers over Gem Type)
        - Rarity Level
        - Description
    - Each gem type should be a link to that gem profile


Page "Type of Gems"/"By brilliance":
    - Show list of gem types from config/config_gem_types.yaml
    - group by "Brilliance Level"  descending
    - Sort by brilliance level descending  
    - Display the information from the /config/config_gem_refraction.yaml file
        - do not display the brilliance level itself, because it is already grouped by it       - Display a table with columns:
            - Gem Type (show Mineral Group when mouse hovers over Gem Type)
            - Refractive Index 
            - Investment Ranking
        - Show all gem types from the config file, no search needed, no filtering needed.
    - Each gem type should be a link to that gem profile page (/gem/GEMTYPE_HERE) 

Page "Type of Gems"/"By availability":
    - Show list of gem types grouped by availability
    - List all gemstones from config/config_gem_types.yaml
    - Sort by availability level descending
    - group by "availability" and Sort groups by availability level descending
    - Display the information from the /config/config_gem_rarity.yaml file
        - do not display the availability itself, because it is already grouped by it
    - Display in a table with columns:
        - Gem Type (show Mineral Group when mouse hovers over Gem Type)
        - Available Level
        - column "Availability Driver" (Limited Deposits, Low Yield, etc.) - use availability_driver from the yaml
        - column "Availability Description" - use availability_description from the yaml
    - Each gem type should be a link to that gem profile

Page "Type of Gems"/"By investment appropriateness":
    - Show list of gem types grouped by investment appropriateness
    - List all gemstones from config/config_gem_types.yaml
    - Sort by investment appropriateness level descending
    - group by "investment_appropriateness" and Sort groups by investment_appropriateness level descending
        - see the order and levels in config/config_gem_metadata.txt
    - Display the information from the /config/config_gem_rarity.yaml file
        - do not display the investment_appropriateness itself, because it is already grouped by it
        - those gems that exist in config_gem_types.yaml but missing in config_gem_rarity.yaml should be shown at the bottom under "Unknown Investment Appropriateness" group
    - Display in a table with columns:
        - Gem Type (show Mineral Group when mouse hovers over Gem Type)
        - Investment Appropriateness Level
        - column "Investment Description" - use investment_description from the yaml
    - Each gem type should be a link to that gem profile

Page "Type of Gems"/"By colors":
    - The page will have two sections:
        - top and narrow section with all colors
        - bottom and larger section with gem types
    - In the top section:
        - Show all distinct colors from config/config_gem_colors.yaml
        - List only the primary colors (the attribute color_primary from config/config_gem_colors.yaml)
        - Each color should be a small gem shaped picture (with the name of the color as tooltip when mouse hovers over it)
            - If you cannot find such pictures, create them as colored circled boxes with border and the color name inside the circle
                - Both name and arrows should be inside the color circle/box
        - If any of colors is clicked, the bottom section should be filtered to show only gem types that have this color
    - In the bottom section:
        - Show list of gem types from config/config_gem_types.yaml
        - Gem type should be followed by its colors in parentheses
            - Example: "Ruby: Red, Pink, Purple"
            - Indicate next to each color the rarity level in that color:
                - "Very Rare": 2 green arrows up (arrows should have a border to be visible on any background)
                - "Rare": 1 green arrow up
                - "Uncommon": 1 red arrow down 
                - "Common": 2 red arrows down 
        - Each gem type should be a link to that gem profile
        - Each color should be a link to search on Gem Rock Auctions site for that color:
            - Use this search URL format: https://www.gemrockauctions.com/search?query=hot%20pink%20spinel

Page "Investments"/"Investment Rankings":
    - First of all, explain that investment rankings and describe the methodology of my investment rankings
    - The overall ranking is calculated on the scale from 0 to 100
    - The ranking is calculated based on the following factors:
        - Geological Rarity (weight: 25%)
            - Singular Occurrence: 100 points
            - Unique Geological: 85 points
            - Limited Occurrence: 65 points
            - Abundant Minerals: 35 points
            - Unknown/Not Assessed: 0 points
        - Market Availability (weight: 25%)
            - Museum Grade Rarity: 100 points
            - Collectors Market: 85 points
            - Limited Supply: 65 points
            - Readily Available: 35 points
            - Consistently Available: 10 points
        - Investment Appropriateness (Weight: 25%)
            - Blue Chip Investment Gems: 100 points
            - Emerging Investment Gems: 75 points
            - Speculative Collector Gems: 50 points
            - Fashion/Trend Gems: 25 points
            - Non-Investment Gems: 5 points
        - Hardness (weight: 12.5%)
            - Extremely Hard (10): 100 points
            - Very Hard (8.5-9.9): 85 points
            - Hard-2 (8.0-8.49): 65 points
            - Hard-1 (7.5-7.99): 45 points
            - Medium-2 (7.0-7.49): 25 points
            - Medium-1 (6.0-6.99): 10 points
            - Soft (3.0-5.99): 5 points
            - Very Soft (1.0-2.99): 0 points
        - Price Range (weight: 12.5%)
            - Ultra-Luxury ($50,000+ per carat): 100 points
            - Super-Premium ($10,000-50,000 per carat): 85 points
            - Premium ($1,000-10,000 per carat): 65 points
            - High-End ($500-3,000 per carat): 45 points
            - Mid-Range ($100-500 per carat): 25 points  
            - Affordable ($50-200 per carat): 10 points
            - Budget-Friendly ($5-50 per carat): 5 points
    - Formula of "Composite Score" = (Geological_Rarity * 0.25) + (Market_Availability * 0.25) + (Investment_Appropriateness * 0.25) + (Hardness * 0.125) + (Price_Accessibility * 0.125)
    - Having calculated the composite score, assign investment ranking tiers:
        - 80-100: VERY BULLISH ⬆⬆⬆
        - 70-79.99: BULLISH ⬆⬆
        - 50-69.99: MODERATELY BULLISH ⬆
        - 45-49.99: NEUTRAL
        - 30-44.99: BEARISH ⬇
        - 0-29.99: VERY BEARISH ⬇⬇
    - Display a table with columns:
        - Investment Ranking Tier
        - Composite Score
        - Gem Type (show Mineral Group when mouse hovers over Gem Type)
        - Geological Rarity
        - Market Availability
        - Investment Appropriateness
        - Hardness 
    - The investment ranking should be clickable and navigate to "Gem Type Profile" page for that gem type

Page(s) "Gem Type Profile":
    - There should be one such page per each gem type
    - The page URL should be like /gem/GEMTYPE_HERE (all lowercase, spaces replaced with underscores)
    - The page should have the following information:
        - Header Section (to the left from "Investment Ranking" box) - it will be in the div "profile-left":
            - Key Properties:
                - Gem Type Name as the page title
                - Mineral Group
                - Mohs Hardness
                - Typical Size
                - Typical Price Range
                - Rarity Level  
                - Availability Level
                - Availability Driver 
                - Investment Appropriateness Level 
            - Detailed Descriptions:
                - Rarity Description
                - Availability Description
                - Investment Appropriateness Description
        - Investment Ranking Section (to the right from the Header Section) - it will be in the div "profile-right":
            - Investment ranking should be illustrated as a gauge chart showing the composite score on a scale from 0 to 100
                - display it in a box in the top right corner of the page (beginning from the same level as the gem type title)
                - it should be a box similar to what Chaikinanalytics.com uses for its stock ratings
                - first of all display the ranking tier - font size should be big and prominent:
                    - bullish and very bullish are green
                    - around neutral is orange
                    - bearish and very bearish are red
                - show gauge for the overall composite score from red area to green area
                    - the main gauge should have a light barely visible border, becuase of the background gradient
                    - the gauge needle should point to the composite score on the gauge
                - do not show the label "Composite Score" on the overall gauge, just show the score number (bigger and bold font)
                - show similar progress bar looking gauges for each of the 5 factors that make up the composite score
                - factors gauges should be similar looking but smaller and horizontal
        - Show "Price Monitoring" section:
            - Display 3 big numbers:
                - Typical Price i.e. $3,000/ct (from [GemAPI].[GetGemPricingPage], value TypicalPPC)
                - Listing Price i.e. $2,500/ct (from [GemAPI].[GetGemPricingPage], value ListingPPC)
                - Sold Price i.e. $1,500/ct (from [GemAPI].[GetGemPricingPage], value SoldPPC)
                - Discount level - show a number with 2 precision. Usually between 0 and 1, rarely above 1.
                - Inside this section display an interactive Price Calculator:
                    - Inputs:
                        - Weight, ct
                        - Dropdown "Faceted/Rough/Specimen" (by default - Faceted)
                        - Checkbox "Good Clarity"
                        - Checkbox "Is Treated"
                        - Checkbox "Is Certified"
                    - Output:
                        - Display "Typical cost" - using columns from Gems.vGemPricing (serverd by[GemAPI].[GetGemPricingPage])
                            - depends on size, clarity, treatment, certification
                        - Display "Likely listed cost" - ListingPPC * weight , use correction to RoughMaterial or SpecimenOnMatrix
                        - Display "Likely sold cost" - SoldPPC * weight , use correction to RoughMaterial or SpecimenOnMatrix
                    - In the calculator-  remove the button "Calculate", recompute whenever the user changed the weight
                    - Display columns "Total Value" and "Price per Carat"
                    - make those 3 key prices as a 3 large cards (aligned horizontally), Discount level a 4th card in this row.

        - Other sectoins below the header and investment ranking - it will be in the div "profile-bottom":
            - Colors (with rarity levels indicated by arrows as on the "By colors" page)
            - Link to Buy on Blue Nile site for that gem type (visible only if sapphire, ruby, emerald)
            - Link to Buy on Gem Rock Auctions site for that gem type
            - Link to Buy on Best In Gems site for that gem type
            - Investment Ranking Tier and Composite Score (if applicable)
            - Explanation of how the investment ranking was calculated for this gem type
            - Current Listings
    - Show "Related Gems Pricing" section
        - list a table with other gems in this group
        - show columns:
            - Gem type name
            - Investment Ranking
            - Typical Price i.e. $3,000/ct
            - Listing Price
            - Sold Price
    - Show "Current Listings" as a table 
        - show the listings ONLY(!) if the user signed in
        - pass parameter google_user_id if known (if user is logged in)
        - make as little spaceing between lines as possible (i.e. 1px)
        - make sure there us NO REFERRER, so that when user clicks on the listings, my site will not be exposed. use no-referrer !
        - the table should take all width of the main content area (the investment ranking column should not steal space from this table)
        - take data from Web Api endpoint /api/v1/listings-view/
            - filter by gem_type_id
        - with columns:
            - Listing ID, fixed width
            - Carat Weight, fixed width
            - Price (add $ and alighn to the right), fixed width
            - Title (link to the listing) - nowrap, expand as much as other columsn allow
                - should go to https://www.gemrockauctions.com/products/<title>-<listing_id> (replace punctuation with "-")
            - Seller (link to the seller's page on the store site)
                - should go to https://www.gemrockauctions.com/stores/<seller_name> 

Page "My Profile":
    - Users authentication using Google OAuth
        - Allow users to sign in with their Google account (Google OAuth)
        - Create a user profile system that stores: Google ID, email address, full name, and profile picture URL
        - Keep users logged in across sessions using secure cookies
        - Add a "Sign in with Google" button on the homepage
        - Add a "Logout" button that appears when users are logged in
    - PROFILE PAGE
        - Create a user profile page at /profile that shows:
            - Profile picture from Google , and some info to the right from picture:
                - User's name
                - Email address  
                - Google ID
                - When you display name, id, address - show it in a table so that the values are aligned
        - Only logged-in users should be able to access the profile page
        - Redirect non-logged-in users to the login page if they try to access /profile
    - TECHNICAL SETUP:
        - Use Flask-Login for session management
            - Menu items "Sign In" and "Logout" should appear conditionally based on login status
            - User's name and profile picture should be displayed when logged in
        - Use Authlib or similar library for Google OAuth integration
            - Create necessary files and variables in GitHub and Google Cloud Console, then let me know where should I put secrets
        - Store user data in a SQLite database (or whatever database I'm currently using)
            - create SQLite database called gems_portfolio.db
        - Create a table called "table_users" with these fields: id, google_id, email, name, profile_pic, created_at
        - Set up proper error handling for failed logins
    - SECURITY:
        - Use environment variables for Google OAuth credentials (client ID and secret)
        - Implement CSRF protection for forms
        - Use secure session cookies
        - Only allow one account per Google ID
    - Profile page Editing features:
        - Field "Preferred Store": dropdown with options "Gem Rock Auctions", "Best In Gems"
        - Field "Minimal Investment Tier": dropdown with options from the possible values of "Investment Appropriateness" from config_gem_metadata.txt
        - Display the header attributes in a table, so that the input fields (text boxes, dropdowns) are aligned
        - AFter the header I need a tab control with tabs below:
            - "Gem Preferences":
                - Display a list of all gem types  with input fields to the right of each gem type
                    - There are more than 100 gem types, so there will be more than 100 rows, no pagination, show all
                    - if 8 fields for each gem type then there will be more than 800 input fields on this page
                - Checkbox "Ignore" (is_ignored)
                - Checkbox "Hunt" (is_hunted)
                - Input box "Hunt PPC" (max_hunt_price_per_ct)
                - Input box "Hunt COST" (max_hunt_total_cost)
                - Input box "Hunt Weight" (min_hunt_weight)
                - Input box "Premium PPC" (max_premium_price_per_ct)
                - Input box "Premium COST" (max_premium_total_cost)
                - Input box "Premium Weight" (min_premium_weight)
            - tab "Store Preferences":

Page "Holdings":
    - Your Holdings: remove purchase cost and shippng cost, but add column invoice number. should be link to https://www.gemrockauctions.com/checkouts/invoice/1004270

Page "Add/Edit Gem Holding":
    - Field to search for gem type
    - List box with gem types matching the search (or display all gem types listed in alphabetical order if search box is empty)
    - Quantity (Number of gems in the parcel) - prefill with "1"
    - Weight, ct
    - purchase cost
    - shipping cost
    - purchase date
    - Notes

Page "Add GRA Invoice":
    - this page allows to enter multiple holdings at once based on a single invoice from Gem Rock Auctions
    - have section for "header" information:
        - Invoice Number
        - Purchase Date
        - Seller Name
        - Total Amount Paid
    - below the header section have a table with input fields for each gem holding in this invoice:
        - Gem Type (dropdown with all gem types)
        - Carat Weight
        - Price Paid
        - Clarity
        - Color
        - Cut
        - Treatment
        - Certification Lab
    - There should be a button "Add Another Gem" that will add another row to the table for another gem holding
    -   wight pattern should not prevent you from parsing out the title. you should remove any waight patters from title parsing, and only once you parsed every title, you should look for weight inside each individual title.

Page Print Tags (/portfolio/tags):
    - The intention is to have a printable page with fixed size boxes 
    - Each box is a label that I will put into a ziploc bag with the gem inside
    - Use data from the endpoint that calls GemAPI.Search_Page_MyPortfolio
    - The label should have the following information:
        - InventoryCode (bold font, bigger size)
        - GemTypeName (GemTypeDisplayName)1
        - Weight 
        - Invoice Number
        - Seller Name
        - Purchase Cost 
    - Zip locks 1.5 x 1.5 inches. Reduce by 1mm horizontally
    - Tags should have border. For cutting.

    I need to install Google Tag Manager code on every page for SEO and analytics purposes.:
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YCG7NVM0MV"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-YCG7NVM0MV');
    </script>




