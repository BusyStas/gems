<aside class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
    <div class="sidebar-header">
        <h2>{{ config.SITE_NAME }}</h2>
        <button class="menu-toggle-btn" id="menuToggle" aria-label="Toggle menu">
            ☰
        </button>
    </div>
    
    <nav class="sidebar-menu">
        <ul class="menu-list">
            {% for item in menu_items %}
            <li class="menu-item {% if item.get('submenu') %}has-submenu{% endif %}" data-has-submenu="{% if item.get('submenu') %}true{% else %}false{% endif %}">
                {% if item.get('submenu') %}
                <a href="#" class="menu-link {% if request.path.startswith(item.url) and item.url != '/' %}active{% elif request.path == '/' and item.url == '/' %}active{% endif %}">
                    <span class="menu-icon">{% include 'includes/icons/' ~ item.icon ~ '.svg' %}</span>
                    <span class="menu-text">{{ item.title }}</span>
                    <span class="submenu-arrow">›</span>
                </a>
                {% else %}
                <a href="{{ item.url }}" class="menu-link {% if request.path.startswith(item.url) and item.url != '/' %}active{% elif request.path == '/' and item.url == '/' %}active{% endif %}">
                    <span class="menu-icon">{% include 'includes/icons/' ~ item.icon ~ '.svg' %}</span>
                    <span class="menu-text">{{ item.title }}</span>
                </a>
                {% endif %}
                
                {% if item.get('submenu') %}
                <ul class="submenu">
                    {% for subitem in item.submenu %}
                    <li class="submenu-item">
                        <a href="{{ subitem.url }}" class="submenu-link {% if request.path == subitem.url %}active{% endif %}">
                            {{ subitem.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </nav>
    <div class="sidebar-footer" style="padding:0.5rem 1rem; margin-top:auto;">
        {% if user_logged_in %}
            <a href="{{ url_for('profile.show_profile') }}" class="menu-link" style="display:block;">Profile{% if current_user and current_user.name %} ({{ current_user.name }}){% endif %}</a>
            <a href="{{ url_for('auth.logout') }}" class="menu-link" style="display:block;">Logout</a>
        {% else %}
            <a href="{{ url_for('auth.login') }}" class="menu-link" style="display:block;">Sign in</a>
        {% endif %}
    </div>
</aside>

<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Toggle sidebar collapsed state (desktop only)
    const menuToggleBtn = document.getElementById('menuToggle');
    if (menuToggleBtn) {
        menuToggleBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            // Only allow collapse/expand on desktop
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.toggle('collapsed');
            }
        });
    }
    
    // Add click handlers to all menu items with submenus
    const menuItems = document.querySelectorAll('.menu-item.has-submenu');
    menuItems.forEach(function(menuItem) {
        const menuLink = menuItem.querySelector('.menu-link');
        const submenu = menuItem.querySelector('.submenu');
        
        if (menuLink && submenu) {
            menuLink.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Close all other open submenus
                const allMenuItems = document.querySelectorAll('.menu-item.has-submenu');
                allMenuItems.forEach(function(item) {
                    if (item !== menuItem) {
                        item.classList.remove('open');
                    }
                });
                
                // Toggle this submenu
                const isOpen = menuItem.classList.toggle('open');
                
                // Position submenu only on desktop
                if (isOpen && window.innerWidth > 768) {
                    const rect = menuLink.getBoundingClientRect();
                    submenu.style.top = rect.top + 'px';
                } else if (isOpen && window.innerWidth <= 768) {
                    // On mobile, remove any fixed positioning
                    submenu.style.top = '';
                }
            });
        }
    });
    
    // Close submenus when clicking outside
    document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('sidebar');
        if (sidebar && !sidebar.contains(event.target)) {
            const allMenuItems = document.querySelectorAll('.menu-item.has-submenu');
            allMenuItems.forEach(function(item) {
                item.classList.remove('open');
            });
        }
    });
    
    // Reposition submenus on scroll (desktop only)
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
        sidebar.addEventListener('scroll', function() {
            if (window.innerWidth > 768) {
                const openMenuItems = document.querySelectorAll('.menu-item.has-submenu.open');
                openMenuItems.forEach(function(menuItem) {
                    const menuLink = menuItem.querySelector('.menu-link');
                    const submenu = menuItem.querySelector('.submenu');
                    if (menuLink && submenu) {
                        const rect = menuLink.getBoundingClientRect();
                        submenu.style.top = rect.top + 'px';
                    }
                });
            }
        });
    }
    
    // Handle window resize - reset submenu positioning
    window.addEventListener('resize', function() {
        const openMenuItems = document.querySelectorAll('.menu-item.has-submenu.open');
        openMenuItems.forEach(function(menuItem) {
            const submenu = menuItem.querySelector('.submenu');
            if (submenu) {
                if (window.innerWidth <= 768) {
                    submenu.style.top = '';
                } else {
                    const menuLink = menuItem.querySelector('.menu-link');
                    if (menuLink) {
                        const rect = menuLink.getBoundingClientRect();
                        submenu.style.top = rect.top + 'px';
                    }
                }
            }
        });
    });
});
</script>
