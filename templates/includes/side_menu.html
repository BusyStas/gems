<aside class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
    <nav class="sidebar-menu">
        <ul class="menu-list">
            {% for item in menu_items %}
            <li class="menu-item {% if item.get('submenu') %}has-submenu{% endif %}" data-has-submenu="{% if item.get('submenu') %}true{% else %}false{% endif %}">
                {% if item.get('submenu') %}
                <a href="#" class="menu-link {% if request.path.startswith(item.url) and item.url != '/' %}active{% elif request.path == '/' and item.url == '/' %}active{% endif %}">
                    <span class="menu-icon">{% include 'includes/icons/' ~ item.icon ~ '.svg' %}</span>
                    <span class="menu-text">{{ item.title }}</span>
                    <span class="submenu-arrow">â€º</span>
                </a>
                {% else %}
                <a href="{{ item.url }}" class="menu-link {% if request.path.startswith(item.url) and item.url != '/' %}active{% elif request.path == '/' and item.url == '/' %}active{% endif %}">
                    <span class="menu-icon">{% include 'includes/icons/' ~ item.icon ~ '.svg' %}</span>
                    <span class="menu-text">{{ item.title }}</span>
                </a>
                {% endif %}
                
                {% if item.get('submenu') %}
                <ul class="submenu">
                    {% for subitem in item.submenu %}
                    <li class="submenu-item">
                        <a href="{{ subitem.url }}" class="submenu-link {% if request.path == subitem.url %}active{% endif %}">
                            {{ subitem.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </nav>
    <div class="sidebar-footer" style="padding:0.5rem 1rem; margin-top:auto;">
        {% if user_logged_in %}
            <a href="{{ url_for('profile.show_profile') }}" class="menu-link" style="display:block;">Profile{% if current_user and current_user.name %} ({{ current_user.name }}){% endif %}</a>
            <a href="{{ url_for('auth.logout') }}" class="menu-link" style="display:block;">Logout</a>
        {% else %}
            <a href="{{ url_for('auth.login') }}" class="menu-link" style="display:block;">Sign in</a>
        {% endif %}
    </div>
</aside>

<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('side_menu.js: loaded');
    // Toggle sidebar collapsed state (desktop only) or show/hide (mobile)
    const menuToggleBtn = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    if (menuToggleBtn && sidebar) {
        menuToggleBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (window.innerWidth > 768) {
                // Desktop: collapse/expand
                sidebar.classList.toggle('collapsed');
            } else {
                // Mobile: main.js handles opening/closing the overlay and sidebar class
                // Avoid duplicating behavior here - just log for debugging
                console.log('side_menu.js: menuToggle clicked on mobile; main.js will handle opening/closing.');
            }
        });
    }

        // Add click handlers for submenus using event delegation (more robust on mobile)
        const sidebarEl = document.getElementById('sidebar');
        if (sidebarEl) {
            const foundMenuItems = sidebarEl.querySelectorAll('.menu-item.has-submenu');
            console.log('side_menu.js: found menuItems', foundMenuItems.length);
                sidebarEl.addEventListener('click', function(e) {
                    const menuLink = e.target.closest('.menu-link');
                    if (!menuLink) return;
                    const menuItem = menuLink.closest('.menu-item');
                    if (!menuItem) return;
                    const submenu = menuItem.querySelector('.submenu');
                    const isParent = menuItem.classList.contains('has-submenu');
                    console.log('side_menu.js (delegation): clicked menuLink', menuLink.querySelector('.menu-text') ? menuLink.querySelector('.menu-text').textContent.trim() : 'unknown', 'isParent', isParent);

                    if (isParent) {
                        // This is a parent menu link with a submenu: toggle behavior
                        e.preventDefault();
                        e.stopPropagation();

                        // Close all other open submenus
                        const allMenuItems = sidebarEl.querySelectorAll('.menu-item.has-submenu');
                        allMenuItems.forEach(function(item) {
                            if (item !== menuItem) {
                                item.classList.remove('open');
                            }
                        });

                        // Toggle this submenu
                        const isOpen = menuItem.classList.toggle('open');
                        console.log('side_menu.js: submenu open state for', menuLink.querySelector('.menu-text') ? menuLink.querySelector('.menu-text').textContent.trim() : 'unknown', isOpen);

                        // Position submenu only on desktop
                        if (isOpen && window.innerWidth > 768) {
                            const rect = menuLink.getBoundingClientRect();
                            submenu.style.top = rect.top + 'px';
                        } else {
                            // On mobile or when closing, remove any fixed positioning
                            submenu.style.top = '';
                        }
                    } else {
                        // Not a submenu parent; this is a real link to navigate. If mobile, close the menu and let the navigation occur.
                        if (window.innerWidth <= 768) {
                            console.log('side_menu.js: closing mobile menu due to non-submenu link click', menuLink.href);
                            const overlayEl = document.getElementById('mobile-overlay');
                            if (overlayEl) overlayEl.classList.remove('active');
                            sidebarEl.classList.remove('active');
                        }
                        // Do not preventDefault; allow the link navigation
                    }
                });
        }

    // Close submenus and mobile menu when clicking outside
    document.addEventListener('click', function(event) {
        const sidebarEl = document.getElementById('sidebar');
        const menuToggleBtn = document.getElementById('menuToggle');
        const isClickOnMenuToggle = menuToggleBtn ? (event.target === menuToggleBtn || menuToggleBtn.contains(event.target)) : false;

        if (sidebarEl && !sidebarEl.contains(event.target) && !isClickOnMenuToggle) {
            // Close submenus
            const allMenuItems = document.querySelectorAll('.menu-item.has-submenu');
            allMenuItems.forEach(function(item) {
                item.classList.remove('open');
            });

            // Close mobile menu
            if (window.innerWidth <= 768) {
                sidebarEl.classList.remove('active');
            }
        }
    });

    // Close mobile menu when clicking on a regular menu item (not submenu parent)
    document.querySelectorAll('.menu-link').forEach(function(link) {
        link.addEventListener('click', function(e) {
            const menuItem = link.closest('.menu-item');
            // Only close sidebar if not a submenu parent or if submenu is not open
            if (( !menuItem.classList.contains('has-submenu') || !menuItem.classList.contains('open') ) && window.innerWidth <= 768) {
                const sidebarEl = document.getElementById('sidebar');
                if (sidebarEl) {
                    sidebarEl.classList.remove('active');
                }
            }
        });
    });

    // Reposition submenus on scroll (desktop only)
    const sidebarScroll = document.getElementById('sidebar');
    if (sidebarScroll) {
        sidebarScroll.addEventListener('scroll', function() {
            if (window.innerWidth > 768) {
                const openMenuItems = document.querySelectorAll('.menu-item.has-submenu.open');
                openMenuItems.forEach(function(menuItem) {
                    const menuLink = menuItem.querySelector('.menu-link');
                    const submenu = menuItem.querySelector('.submenu');
                    if (menuLink && submenu) {
                        const rect = menuLink.getBoundingClientRect();
                        submenu.style.top = rect.top + 'px';
                    }
                });
            }
        });
    }

    // Handle window resize - reset submenu positioning
    window.addEventListener('resize', function() {
        const openMenuItems = document.querySelectorAll('.menu-item.has-submenu.open');
        openMenuItems.forEach(function(menuItem) {
            const submenu = menuItem.querySelector('.submenu');
            if (submenu) {
                if (window.innerWidth <= 768) {
                    submenu.style.top = '';
                } else {
                    const menuLink = menuItem.querySelector('.menu-link');
                    if (menuLink) {
                        const rect = menuLink.getBoundingClientRect();
                        submenu.style.top = rect.top + 'px';
                    }
                }
            }
        });
    });
});
</script>
