{% extends 'base.html' %}

{% block extra_css %}
<style>
/* Profile grid: left content + right fixed-width gauge panel */
.profile-grid { display: grid; grid-template-columns: 1fr minmax(280px, 360px); gap: 8px; align-items: start; width:100%; }
.profile-left { min-width: 0; }
.profile-right { display:flex; justify-content:center; }
.profile-right .gauge {
  position: sticky;
  top: calc(var(--top-nav-height) + 8px);
  background: var(--soft-blue);
  padding: 12px 14px; /* compact padding to avoid stealing space */
  overflow: visible; /* allow SVG stroke to extend above the box without clipping */
  border-radius: 8px;
  border: 1px solid rgba(37,99,235,0.08); /* subtle outer border */
  border-left: 6px solid var(--medium-blue); /* prominent left accent */
  box-shadow: 0 1px 3px rgba(16,24,40,0.02);
  box-sizing: border-box;
  max-width: 260px;
  width: 100%;
  margin: 0 auto; /* center gauge within the right column */
}
.gauge svg { display: block; margin: 0 auto 8px; max-width: 100%; }
.gauge svg text.score-number { font-weight: 800; font-size: 44px; fill: #1a1a1a; }
.gauge-number { text-align: center; font-size: 34px; font-weight: 800; color: #1a1a1a; margin-bottom: 8px; line-height:1; }
.tier-indicator { display:inline-block; padding:8px 16px; border-radius:24px; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; margin-bottom:12px; font-size:16px; }
.tier-indicator.green { background: rgba(11,138,11,0.12); color: #0b8a0b; }
.tier-indicator.orange { background: rgba(240,173,78,0.12); color: #f0ad4e; }
.tier-indicator.red { background: rgba(244,67,54,0.12); color: #f44336; }
.components { margin-top: 16px; }
.components h4 { font-size: 14px; font-weight: 700; color: var(--dark-gray); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
.comp-row { display:flex; align-items:center; gap:0.5rem; margin-bottom:0.6rem; }
.comp-label { width: 38%; font-size: 0.85rem; color: var(--dark-gray); }
.comp-bar { background:#e8e8e8; width: 45%; height:14px; border-radius:8px; overflow:hidden; }
.comp-fill { background: linear-gradient(90deg,#f44336,#ffec3d,#0b8a0b); height:100%; width:0; }
.comp-value { width: 12%; text-align:right; font-weight:700; color:var(--dark-gray); font-size:0.9rem; }

/* Info table styling */
.info-table { width: 100%; border-collapse: collapse; margin: 4px 0; table-layout: fixed; word-break: break-word; }
.info-table th { background: var(--soft-blue); padding: 2px 6px; text-align: left; font-weight: 700; color: var(--dark-blue); border: 1px solid var(--medium-blue); font-size: 12px; }
.info-table td { padding: 2px 6px; border: 1px solid var(--medium-blue); color: var(--dark-gray); font-size: 13px; }
.info-table { line-height: 1.05; }
.info-table tr:nth-child(even) { background: rgba(37,99,235,0.02); }
.info-table tr:hover { background: rgba(37,99,235,0.05); }
/* Align price column right */
.info-table th:nth-child(3), .info-table td:nth-child(3) { text-align: right; }

/* Column-specific classes */
.info-table .col-id { white-space: nowrap; }
.info-table .col-weight { white-space: nowrap; }
.info-table .col-price { white-space: nowrap; text-align: right; }
.info-table .col-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.info-table .col-seller { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.listing-title-link { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display:inline-block; max-width:100%; }

/* Color list styling with arrows */
.color-list { list-style: none; padding: 0; margin: 16px 0; }
.color-list li { display: inline-block; margin-right: 1rem; margin-bottom: 0.8rem; padding: 6px 12px; background: var(--soft-blue); border-radius: 6px; border: 1px solid var(--medium-blue); }
.color-badge { display: inline-block; width: 20px; height: 20px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.2); vertical-align: middle; margin-right: 6px; }
.rarity-arrow { display: inline-block; font-size: 14px; margin-left: 4px; font-weight: bold; }
.rarity-arrow.green { color: #0b8a0b; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; }
.rarity-arrow.red { color: #f44336; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; }

/* Section headers */
.section-header { margin-top: 32px; margin-bottom: 16px; color: var(--dark-blue); font-size: 20px; font-weight: 700; border-bottom: 2px solid var(--medium-blue); padding-bottom: 8px; }

/* Links section */
.buy-links { margin: 20px 0; }
.buy-links a { display: inline-block; margin-right: 16px; margin-bottom: 8px; padding: 10px 20px; background: var(--medium-blue); color: white; text-decoration: none; border-radius: 6px; font-weight: 600; transition: background 0.2s; }
.buy-links a:hover { background: var(--dark-blue); }

@media (max-width: 900px) { 
  .profile-grid { grid-template-columns: 1fr; } 
  .profile-right { order: -1; width:100%; }
  .gauge { position: static !important; width: auto; }
  .gauge svg { transform: none; max-width:100%; } 
}
.profile-bottom { margin-top: 18px; width: 100%; }
.profile-bottom .section-header { margin-top: 12px; }
/* Make profile-bottom span both grid columns */
.profile-grid .profile-bottom { grid-column: 1 / -1; }
</style>
{% endblock %}

{% block content %}
  <div class="profile-grid">
    <div class="profile-left">
      <h1>{{ gem_name }}</h1>
      <p style="font-size: 16px; color: var(--dark-gray); margin-bottom: 24px;"><strong>Mineral Group:</strong> {{ mineral_group or 'Unknown' }}</p>

      <h2 class="section-header">Key Properties</h2>
      <table class="info-table">
        <tr>
          <th>Property</th>
          <th>Value</th>
        </tr>
        <tr>
          <td><strong>Mohs Hardness</strong></td>
          <td>{% if hardness_val and hardness_val|float > 0 %}{{ hardness_val|round(2) }}{% if hardness_str %} ({{ hardness_str }}){% endif %}{% else %}Unknown{% endif %}</td>
        </tr>
        <tr>
          <td><strong>Typical Size</strong></td>
          <td>{{ typical_size or 'Unknown' }}</td>
        </tr>
        <tr>
          <td><strong>Typical Price Range</strong></td>
          <td>{{ typical_price or 'Unknown' }}</td>
        </tr>
        <tr>
          <td><strong>Rarity Level</strong></td>
          <td>{{ rarity_label or 'Unknown' }}</td>
        </tr>
        <tr>
          <td><strong>Availability Level</strong></td>
          <td>{{ availability_label or 'Unknown' }}</td>
        </tr>
        {% if availability_driver %}
        <tr>
          <td><strong>Availability Driver</strong></td>
          <td>{{ availability_driver }}</td>
        </tr>
        {% endif %}
        <tr>
          <td><strong>Investment Appropriateness</strong></td>
          <td>{{ investment_label or 'Unknown' }}</td>
        </tr>
      </table>

      {% if pricing and (pricing.TypicalPPC or pricing.ListingPPC or pricing.SoldPPC or pricing.CertificationImpact) %}
      <h2 class="section-header">Pricing</h2>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
        <div style="background: linear-gradient(135deg, var(--soft-blue) 0%, #e8f4fc 100%); border: 2px solid var(--medium-blue); border-radius: 12px; padding: 20px; text-align: center;">
          <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px; font-weight: 500;">Typical Price</div>
          <div style="font-size: 1.8rem; font-weight: 700; color: var(--dark-blue);">
            {% if pricing.TypicalPPC %}${{ "%.2f"|format(pricing.TypicalPPC) }}{% else %}N/A{% endif %}
          </div>
          <div style="font-size: 0.75rem; color: #888; margin-top: 4px;">per carat</div>
        </div>
        <div style="background: linear-gradient(135deg, #f0f7ff 0%, #d9eaff 100%); border: 2px solid #a8c8e8; border-radius: 12px; padding: 20px; text-align: center;">
          <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px; font-weight: 500;">Listing Price</div>
          <div style="font-size: 1.8rem; font-weight: 700; color: #2a6496;">
            {% if pricing.ListingPPC %}${{ "%.2f"|format(pricing.ListingPPC) }}{% else %}N/A{% endif %}
          </div>
          <div style="font-size: 0.75rem; color: #888; margin-top: 4px;">per carat</div>
        </div>
        <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #81c784; border-radius: 12px; padding: 20px; text-align: center;">
          <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px; font-weight: 500;">Sold Price</div>
          <div style="font-size: 1.8rem; font-weight: 700; color: #2e7d32;">
            {% if pricing.SoldPPC %}${{ "%.2f"|format(pricing.SoldPPC) }}{% else %}N/A{% endif %}
          </div>
          <div style="font-size: 0.75rem; color: #888; margin-top: 4px;">per carat</div>
        </div>
        <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ffb74d; border-radius: 12px; padding: 20px; text-align: center;">
          <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px; font-weight: 500;">Discount Level</div>
          <div style="font-size: 1.8rem; font-weight: 700; color: #e65100;">
            {% if pricing.DiscountLevel is not none %}{{ "%.1f"|format(pricing.DiscountLevel) }}{% else %}N/A{% endif %}
          </div>
          <div style="font-size: 0.75rem; color: #888; margin-top: 4px;">vs typical</div>
        </div>
      </div>

      <h3 style="margin-top: 24px; margin-bottom: 12px; color: var(--dark-blue);">Price Calculator</h3>
      <div class="price-calculator" style="background: var(--soft-blue); padding: 16px; border-radius: 8px; border: 1px solid var(--medium-blue);">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 16px;">
          <div>
            <label for="calc-weight" style="display: block; font-weight: 600; margin-bottom: 4px;">Weight (carats)</label>
            <input type="number" id="calc-weight" value="1" min="0.01" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--medium-blue); border-radius: 4px;">
          </div>
          <div>
            <label for="calc-type" style="display: block; font-weight: 600; margin-bottom: 4px;">Type</label>
            <select id="calc-type" style="width: 100%; padding: 8px; border: 1px solid var(--medium-blue); border-radius: 4px;">
              <option value="faceted">Faceted</option>
              <option value="cabochon">Cabochon</option>
              <option value="rough">Rough</option>
              <option value="specimen">Specimen</option>
            </select>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; padding-top: 24px;">
            <input type="checkbox" id="calc-clarity">
            <label for="calc-clarity" style="font-weight: 600;">Good Clarity</label>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; padding-top: 24px;">
            <input type="checkbox" id="calc-treated">
            <label for="calc-treated" style="font-weight: 600;">Is Treated</label>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; padding-top: 24px;">
            <input type="checkbox" id="calc-certified">
            <label for="calc-certified" style="font-weight: 600;">Is Certified</label>
          </div>
        </div>
        <div id="calc-results" style="margin-top: 16px;">
          <table class="info-table">
            <tr>
              <th>Estimate Type</th>
              <th>Total Value</th>
              <th>Price per Carat</th>
            </tr>
            <tr>
              <td><strong>Typical Cost</strong></td>
              <td id="result-typical-total">-</td>
              <td id="result-typical-ppc">-</td>
            </tr>
            <tr>
              <td><strong>Likely Listed Cost</strong></td>
              <td id="result-listed-total">-</td>
              <td id="result-listed-ppc">-</td>
            </tr>
            <tr>
              <td><strong>Likely Sold Cost</strong></td>
              <td id="result-sold-total">-</td>
              <td id="result-sold-ppc">-</td>
            </tr>
          </table>
        </div>
      </div>
      {% endif %}

      <h2 class="section-header">Detailed Descriptions</h2>
      <p><strong>Rarity Description:</strong> {{ rarity_description or 'No description available.' }}</p>
      <p><strong>Availability Description:</strong> {{ availability_description or 'No description available.' }}</p>
      <p><strong>Investment Description:</strong> {{ investment_description or 'No description available.' }}</p>
  </div>

      <div class="profile-right">
      <div class="gauge">
        <!-- Ranking tier (prominent) -->
        {% if tier %}
        <div style="text-align: center;">
          <div class="tier-indicator {{ tier_color|default('')|lower() }}">{{ tier }}</div>
        </div>
        {% endif %}
        <!-- Overall composite score shown above the gauge -->
        <div class="gauge-number">{{ composite }}</div>
        <!-- Simple semicircle gauge using SVG -->
        {% set pct = (composite or 0) %}
        <svg viewBox="0 -12 200 124" width="300" height="160" aria-hidden="true" style="overflow:visible;">
          <defs>
            <linearGradient id="grad" x1="0%" x2="100%">
              <stop offset="0%" stop-color="#f44336" />
              <stop offset="50%" stop-color="#ffec3d" />
              <stop offset="100%" stop-color="#0b8a0b" />
            </linearGradient>
          </defs>
          <path d="M10 90 A90 90 0 0 1 190 90" fill="none" stroke="#e8e8e8" stroke-width="16" />
          <path d="M10 90 A90 90 0 0 1 190 90" fill="none" stroke="url(#grad)" stroke-width="16"
                stroke-dasharray="283" stroke-dashoffset="{{ 283 - (283 * (pct/100.0)) }}" stroke-linecap="round" />
        </svg>

        <div class="components">
          <h4>Score Components</h4>
          {% for label, val in composite_components.items() %}
            <div class="comp-row">
              <div class="comp-label">{{ label.replace('_',' ').replace('geological','Geo').replace('market','Mkt').replace('investment','Invest').replace('appropriateness','Appr') }}</div>
              <div class="comp-bar"><div class="comp-fill" style="width: {{ val }}%"></div></div>
              <div class="comp-value">{{ val }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="profile-bottom">
    {% if colors %}
      <h2 class="section-header">Colors</h2>
      <ul class="color-list">
        {% for c in colors %}
          <li>
            <span class="color-badge" style="background:{{ c.hex or '#ccc' }};"></span>
            <strong>{{ c.color }}</strong>
            {% if c.rarity %}
              {% if c.rarity == 'Very Rare' %}
                <span class="rarity-arrow green">⬆⬆</span>
              {% elif c.rarity == 'Rare' %}
                <span class="rarity-arrow green">⬆</span>
              {% elif c.rarity == 'Uncommon' %}
                <span class="rarity-arrow red">⬇</span>
              {% elif c.rarity == 'Common' %}
                <span class="rarity-arrow red">⬇⬇</span>
              {% endif %}
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    <h2 class="section-header">Buy This Gem</h2>
    <div class="buy-links">
      <a href="https://www.gemrockauctions.com/search?query={{ gem_name | urlencode }}" target="_blank" rel="noopener noreferrer" referrerpolicy="no-referrer">Buy on Gem Rock Auctions</a>
      <a href="https://www.bestingems.com/listing/buy-gemstones-online/?filter=gemsname:{{ gem_name | urlencode }}" target="_blank" rel="noopener noreferrer" referrerpolicy="no-referrer">Buy on Best In Gems</a>
    </div>

    <h2 class="section-header">Investment Ranking Calculation</h2>
    <p>The composite score of <strong>{{ composite }}</strong> is calculated using a weighted formula:</p>
    <ul style="line-height: 1.8;">
      <li><strong>Geological Rarity (25%):</strong> {{ composite_components.geological_rarity }} points</li>
      <li><strong>Market Availability (25%):</strong> {{ composite_components.market_availability }} points</li>
      <li><strong>Investment Appropriateness (25%):</strong> {{ composite_components.investment_appropriateness }} points</li>
      <li><strong>Hardness (12.5%):</strong> {{ composite_components.hardness }} points</li>
      <li><strong>Price Range (12.5%):</strong> {{ composite_components.price }} points</li>
    </ul>
    <p><strong>Formula:</strong> ({{ composite_components.geological_rarity }} × 0.25) + ({{ composite_components.market_availability }} × 0.25) + ({{ composite_components.investment_appropriateness }} × 0.25) + ({{ composite_components.hardness }} × 0.125) + ({{ composite_components.price }} × 0.125) = <strong>{{ composite }}</strong></p>

    <h2 class="section-header">Current Listings</h2>
    {% if show_listings %}
      <div id="listings-wrapper">
      <table id="current-listings" class="info-table">
        <colgroup>
          <col style="width: 80px;">
          <col style="width: 90px;">
          <col style="width: 110px;">
          <col>
          <col style="width: 150px;">
        </colgroup>
        <thead>
          <tr>
            <th>Listing ID</th>
            <th>Carat Weight</th>
            <th>Price (USD)</th>
            <th>Title</th>
            <th>Seller</th>
          </tr>
        </thead>
        <tbody>
          {% if current_listings and current_listings|length > 0 %}
            {% for item in current_listings %}
              <tr>
                <td class="col-id">{{ item.listing_id or item.id or '' }}</td>
                <td class="col-weight">{{ item.carat_weight or item.weight or '' }}</td>
                <td class="col-price">{{ item.price or '' }}</td>
                <td class="col-title">{% if item.title_url %}<a class="listing-title-link" href="{{ item.title_url }}" target="_blank" rel="noopener noreferrer" referrerpolicy="no-referrer">{{ item.title or item.listing_title or 'View' }}</a>{% else %}{{ item.title or item.listing_title or '' }}{% endif %}</td>
                <td class="col-seller">{% if item.seller_url %}<a href="{{ item.seller_url }}" target="_blank" rel="noopener noreferrer" referrerpolicy="no-referrer">{{ item.seller or item.seller_nickname or 'Seller' }}</a>{% else %}{{ item.seller or item.seller_nickname or '' }}{% endif %}</td>
              </tr>
            {% endfor %}
          {% else %}
            {% if not show_listings %}
                <tr><td colspan="5" style="text-align:center;">Please sign in to view current listings.</td></tr>
            {% else %}
                <tr><td colspan="5" style="text-align:center;">Loading current listings&hellip;</td></tr>
            {% endif %}
          {% endif %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="no-listings-cta" style="padding:8px 0;">Please sign in to view current listings.</div>
    {% endif %}

    {% if related_gems and related_gems|length > 0 %}
    <h2 class="section-header">Other gems in the {{ mineral_group or 'same' }} group:</h2>
    <table class="info-table" id="related-gems-table">
      <colgroup>
        <col style="width: 35%;">
        <col style="width: 20%;">
        <col style="width: 15%;">
        <col style="width: 15%;">
        <col style="width: 15%;">
      </colgroup>
      <thead>
        <tr>
          <th>Gem Type</th>
          <th>Investment Ranking</th>
          <th>Typical Price</th>
          <th>Listing Price</th>
          <th>Sold Price</th>
        </tr>
      </thead>
      <tbody>
        {% for gem in related_gems %}
        <tr>
          <td><a href="/gems/gem/{{ gem.GemTypeName | lower | replace(' ', '-') }}">{{ gem.GemTypeName }}</a></td>
          <td>{{ gem.InvestmentRanking or 'Not Assessed' }}</td>
          <td style="text-align: right;">{% if gem.TypicalPPC %}${{ "%.2f"|format(gem.TypicalPPC) }}/ct{% else %}-{% endif %}</td>
          <td style="text-align: right;">{% if gem.ListingPPC %}${{ "%.2f"|format(gem.ListingPPC) }}/ct{% else %}-{% endif %}</td>
          <td style="text-align: right;">{% if gem.SoldPPC %}${{ "%.2f"|format(gem.SoldPPC) }}/ct{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}

    {% if user_holdings and user_holdings|length > 0 %}
    <h2 class="section-header">My Holdings</h2>
    <p style="font-size: 14px; color: var(--dark-gray); margin-bottom: 12px;">Your {{ gem_name }} holdings:</p>
    <table class="info-table" id="user-holdings-table">
      <thead>
        <tr>
          <th>Weight (carats)</th>
          <th>Purchase Price</th>
          <th>Current Value</th>
          <th>Purchase Date</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% set total_weight = 0 %}
        {% set total_purchase = 0 %}
        {% set total_current = 0 %}
        {% for holding in user_holdings %}
        <tr>
          <td>{{ "%.2f"|format(holding.weight_carats) if holding.weight_carats else '-' }}</td>
          <td style="text-align: right;">
            {% if holding.purchase_price %}
              ${{ "%.2f"|format(holding.purchase_price) }}
              {% if holding.weight_carats and holding.weight_carats > 0 %}
                <br><span style="font-size: 0.85em; color: #666;">${{ "%.2f"|format(holding.purchase_price / holding.weight_carats) }}/ct</span>
              {% endif %}
            {% else %}-{% endif %}
          </td>
          <td style="text-align: right;">
            {% if holding.current_value %}
              ${{ "%.2f"|format(holding.current_value) }}
              {% if holding.weight_carats and holding.weight_carats > 0 %}
                <br><span style="font-size: 0.85em; color: #666;">${{ "%.2f"|format(holding.current_value / holding.weight_carats) }}/ct</span>
              {% endif %}
            {% else %}-{% endif %}
          </td>
          <td>{{ holding.purchase_date if holding.purchase_date else '-' }}</td>
          <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ holding.notes if holding.notes else '-' }}</td>
        </tr>
        {% if holding.weight_carats %}{% set total_weight = total_weight + holding.weight_carats %}{% endif %}
        {% if holding.purchase_price %}{% set total_purchase = total_purchase + holding.purchase_price %}{% endif %}
        {% if holding.current_value %}{% set total_current = total_current + holding.current_value %}{% endif %}
        {% endfor %}
        <tr style="background: var(--soft-blue); font-weight: bold;">
          <td>{{ "%.2f"|format(total_weight) }} ct</td>
          <td style="text-align: right;">
            {% if total_purchase > 0 %}
              ${{ "%.2f"|format(total_purchase) }}
              {% if total_weight > 0 %}
                <br><span style="font-size: 0.85em; color: #666;">${{ "%.2f"|format(total_purchase / total_weight) }}/ct avg</span>
              {% endif %}
            {% else %}-{% endif %}
          </td>
          <td style="text-align: right;">
            {% if total_current > 0 %}
              ${{ "%.2f"|format(total_current) }}
              {% if total_weight > 0 %}
                <br><span style="font-size: 0.85em; color: #666;">${{ "%.2f"|format(total_current / total_weight) }}/ct avg</span>
              {% endif %}
              {% if total_purchase > 0 %}
                <br><span style="font-size: 0.85em; {% if total_current >= total_purchase %}color: #0b8a0b;{% else %}color: #f44336;{% endif %}">
                  {% if total_current >= total_purchase %}▲{% else %}▼{% endif %}
                  {{ "%.1f"|format(((total_current - total_purchase) / total_purchase * 100)) }}%
                </span>
              {% endif %}
            {% else %}-{% endif %}
          </td>
          <td colspan="2" style="text-align: center;">Total</td>
        </tr>
      </tbody>
    </table>
    {% endif %}
  </div>
  </div>

{% endblock %}



{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // --- Listings logic (only if listings table exists) ---
  const tbody = document.querySelector('#current-listings tbody');
  if (tbody) {
    const params = new URLSearchParams();
    {% if gem_type_id %}
    params.set('gem_type_id', '{{ gem_type_id }}');
    {% else %}
    params.set('gem', '{{ gem_name | escape }}');
    {% endif %}
    {% if current_user and current_user.google_id %}
    params.set('google_user_id', '{{ current_user.google_id }}');
    {% endif %}

    const url = '/api/v1/listings-view/?' + params.toString();

    function renderItems(items) {
      items.forEach(it => {
        if (!('listing_id' in it)) it.listing_id = it.ListingId || it.id || '';
        if (!('carat_weight' in it)) it.carat_weight = it.Weight || it.weight || '';
        if (!('title' in it)) it.title = it.ListingTitle || it.listing_title || '';
        if (!('title_url' in it)) it.title_url = it.listing_url || '';
        if (!('seller' in it)) it.seller = it.SellerNickname || it.seller_nickname || '';
        if (!('seller_url' in it)) it.seller_url = it.seller_profile || '';
        if (!('price' in it)) it.price = it.Price || '';
      });

      tbody.innerHTML = '';
      if (!items.length) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No listings found.</td></tr>';
        return;
      }
      items.forEach(item => {
        const tr = document.createElement('tr');
        const id = document.createElement('td'); id.textContent = item.listing_id || '';
        const w = document.createElement('td'); w.textContent = item.carat_weight != null ? item.carat_weight : '';
        const p = document.createElement('td');
        let priceText = '';
        if (item.price != null) {
          if (typeof item.price === 'number') {
            priceText = '$' + item.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
          } else if (typeof item.price === 'string') {
            priceText = item.price.trim();
            if (!priceText.startsWith('$') && /^\d/.test(priceText)) {
              const pv = parseFloat(priceText.replace(/[, ]/g, ''));
              if (!Number.isNaN(pv)) {
                priceText = '$' + pv.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
              }
            }
          }
        }
        p.textContent = priceText;
        const t = document.createElement('td');
        if (!item.title_url && item.title && item.listing_id) {
          const slug = ('' + item.title).toLowerCase().replace(/[^\w\s-]/g, '').replace(/[\s_]+/g, '-');
          item.title_url = 'https://www.gemrockauctions.com/products/' + slug + '-' + item.listing_id;
        }
        if (item.title_url) {
          const a = document.createElement('a'); a.href = item.title_url; a.target = '_blank'; a.rel='noopener noreferrer'; a.setAttribute('referrerpolicy','no-referrer'); a.textContent = item.title || 'View'; a.classList.add('listing-title-link'); t.appendChild(a);
        } else {
          t.textContent = item.title || '';
        }
        const s = document.createElement('td');
        if (!item.seller_url && item.seller) {
          const sellerSlug = ('' + item.seller).toLowerCase().replace(/[^\w\s-]/g, '').replace(/[\s_]+/g, '-');
          item.seller_url = 'https://www.gemrockauctions.com/stores/' + sellerSlug;
        }
        if (item.seller_url) {
          const a2 = document.createElement('a'); a2.href = item.seller_url; a2.target = '_blank'; a2.rel='noopener noreferrer'; a2.setAttribute('referrerpolicy','no-referrer'); a2.textContent = item.seller || 'Seller'; s.appendChild(a2);
        } else {
          s.textContent = item.seller || '';
        }
        tr.appendChild(id); tr.appendChild(w); tr.appendChild(p); tr.appendChild(t); tr.appendChild(s);
        tbody.appendChild(tr);
      });
    }

    {% if current_listings is defined %}
    const serverItems = {{ current_listings|tojson|safe }};
    {% else %}
    const serverItems = null;
    {% endif %}
    const showListings = {{ 'true' if show_listings else 'false' }};
    if (serverItems && Array.isArray(serverItems) && serverItems.length && showListings) {
      renderItems(serverItems);
    } else if (showListings) {
      fetch(url, { credentials: 'same-origin' })
        .then(r => r.json())
        .then(data => {
          const list = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
          if (Array.isArray(list) && list.length) {
            renderItems(list);
          } else {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No listings found.</td></tr>';
          }
        }).catch(err => {
          console.error('Failed to fetch listings', err);
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Failed to load listings.</td></tr>';
        });
    } else {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Please sign in to view current listings.</td></tr>';
    }
  }

  // --- Price Calculator logic ---
  const calcWeight = document.getElementById('calc-weight');
  const calcType = document.getElementById('calc-type');
  const calcClarity = document.getElementById('calc-clarity');
  const calcTreated = document.getElementById('calc-treated');
  const calcCertified = document.getElementById('calc-certified');

  // Debug: check which elements exist
  console.log('Calculator elements:', {
    calcWeight: !!calcWeight,
    calcType: !!calcType,
    calcClarity: !!calcClarity,
    calcTreated: !!calcTreated,
    calcCertified: !!calcCertified
  });

  if (calcWeight && calcType && calcClarity && calcTreated && calcCertified) {
    // Pricing data from server
    const pricingData = {{ pricing|tojson|safe if pricing else '{}' }};
    console.log('Pricing data loaded:', pricingData);

    function recalculate() {
      try {
        const weight = parseFloat(calcWeight.value) || 1;
        const gemType = calcType.value;
        const hasClarity = calcClarity.checked;
        const isTreated = calcTreated.checked;
        const isCertified = calcCertified.checked;

        // Base prices per carat - convert to number safely
        const typicalPPC = Number(pricingData.TypicalPPC) || 0;
        const listingPPC = Number(pricingData.ListingPPC) || 0;
        const soldPPC = Number(pricingData.SoldPPC) || 0;

        // Multipliers from pricing data - convert to number safely
        const certImpact = Number(pricingData.CertificationImpact) || 1.0;
        const roughMaterial = Number(pricingData.RoughMaterial) || 0.3;
        const specimenOnMatrix = Number(pricingData.SpecimenOnMatrix) || 0.2;
        const treatmentImpact = Number(pricingData.TreatmentImpact) || 0.7;

        // Calculate type multiplier
        let typeMultiplier = 1.0;
        if (gemType === 'rough') {
          typeMultiplier = roughMaterial;
        } else if (gemType === 'specimen') {
          typeMultiplier = specimenOnMatrix;
        } else if (gemType === 'cabochon') {
          typeMultiplier = 0.6; // Cabochons typically less than faceted
        }

        // Apply modifiers
        let modifier = typeMultiplier;
        if (isTreated) {
          modifier *= treatmentImpact;
        }
        if (isCertified) {
          modifier *= certImpact;
        }
        if (hasClarity) {
          modifier *= 1.15; // Good clarity adds ~15% value
        }

        // Calculate adjusted PPC (price per carat with modifiers)
        const typicalAdjPPC = typicalPPC * modifier;
        const listingAdjPPC = listingPPC * modifier;
        const soldAdjPPC = soldPPC * modifier;

        // Calculate total values
        const typicalTotal = typicalAdjPPC * weight;
        const listedTotal = listingAdjPPC * weight;
        const soldTotal = soldAdjPPC * weight;

        // Display results - Total Value column
        document.getElementById('result-typical-total').textContent = typicalTotal > 0 ? '$' + typicalTotal.toFixed(2) : 'N/A';
        document.getElementById('result-listed-total').textContent = listedTotal > 0 ? '$' + listedTotal.toFixed(2) : 'N/A';
        document.getElementById('result-sold-total').textContent = soldTotal > 0 ? '$' + soldTotal.toFixed(2) : 'N/A';

        // Display results - Price per Carat column
        document.getElementById('result-typical-ppc').textContent = typicalAdjPPC > 0 ? '$' + typicalAdjPPC.toFixed(2) : 'N/A';
        document.getElementById('result-listed-ppc').textContent = listingAdjPPC > 0 ? '$' + listingAdjPPC.toFixed(2) : 'N/A';
        document.getElementById('result-sold-ppc').textContent = soldAdjPPC > 0 ? '$' + soldAdjPPC.toFixed(2) : 'N/A';
      } catch (e) {
        console.error('Error in recalculate:', e);
      }
    }

    // Add event listeners to all inputs for auto-calculation
    calcWeight.addEventListener('input', recalculate);
    calcType.addEventListener('change', recalculate);
    calcClarity.addEventListener('change', recalculate);
    calcTreated.addEventListener('change', recalculate);
    calcCertified.addEventListener('change', recalculate);

    // Initial calculation on page load
    recalculate();
  } else {
    console.warn('Price calculator elements not found:', {calcWeight, calcType, calcClarity, calcTreated, calcCertified});
  }
});
</script>
{% endblock %}
