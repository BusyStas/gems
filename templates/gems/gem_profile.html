{% extends 'base.html' %}

{% block extra_css %}
<style>
/* Profile grid: left content + right fixed-width gauge panel */
.profile-grid { display: grid; grid-template-columns: 1fr minmax(280px, 360px); gap: 8px; align-items: start; width:100%; }
.profile-left { min-width: 0; }
.profile-right { display:flex; justify-content:center; }
.profile-right .gauge {
  position: sticky;
  top: calc(var(--top-nav-height) + 8px);
  background: var(--soft-blue);
  padding: 12px 14px; /* compact padding to avoid stealing space */
  overflow: visible; /* allow SVG stroke to extend above the box without clipping */
  border-radius: 8px;
  border: 1px solid rgba(37,99,235,0.08); /* subtle outer border */
  border-left: 6px solid var(--medium-blue); /* prominent left accent */
  box-shadow: 0 1px 3px rgba(16,24,40,0.02);
  box-sizing: border-box;
  max-width: 260px;
  width: 100%;
  margin: 0 auto; /* center gauge within the right column */
}
.gauge svg { display: block; margin: 0 auto 8px; max-width: 100%; }
.gauge svg text.score-number { font-weight: 800; font-size: 44px; fill: #1a1a1a; }
.gauge-number { text-align: center; font-size: 34px; font-weight: 800; color: #1a1a1a; margin-bottom: 8px; line-height:1; }
.tier-indicator { display:inline-block; padding:8px 16px; border-radius:24px; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; margin-bottom:12px; font-size:16px; }
.tier-indicator.green { background: rgba(11,138,11,0.12); color: #0b8a0b; }
.tier-indicator.orange { background: rgba(240,173,78,0.12); color: #f0ad4e; }
.tier-indicator.red { background: rgba(244,67,54,0.12); color: #f44336; }
.components { margin-top: 16px; }
.components h4 { font-size: 14px; font-weight: 700; color: var(--dark-gray); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
.comp-row { display:flex; align-items:center; gap:0.5rem; margin-bottom:0.6rem; }
.comp-label { width: 38%; font-size: 0.85rem; color: var(--dark-gray); }
.comp-bar { background:#e8e8e8; width: 45%; height:14px; border-radius:8px; overflow:hidden; }
.comp-fill { background: linear-gradient(90deg,#f44336,#ffec3d,#0b8a0b); height:100%; width:0; }
.comp-value { width: 12%; text-align:right; font-weight:700; color:var(--dark-gray); font-size:0.9rem; }

/* Info table styling */
.info-table { width: 100%; border-collapse: collapse; margin: 4px 0; table-layout: fixed; word-break: break-word; }
.info-table th { background: var(--soft-blue); padding: 2px 6px; text-align: left; font-weight: 700; color: var(--dark-blue); border: 1px solid var(--medium-blue); font-size: 12px; }
.info-table td { padding: 2px 6px; border: 1px solid var(--medium-blue); color: var(--dark-gray); font-size: 13px; }
.info-table { line-height: 1.05; }
.info-table tr:nth-child(even) { background: rgba(37,99,235,0.02); }
.info-table tr:hover { background: rgba(37,99,235,0.05); }
/* Align price column right */
.info-table th:nth-child(3), .info-table td:nth-child(3) { text-align: right; }

/* Column-specific classes */
.info-table .col-id { white-space: nowrap; }
.info-table .col-weight { white-space: nowrap; }
.info-table .col-price { white-space: nowrap; text-align: right; }
.info-table .col-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.info-table .col-seller { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.listing-title-link { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display:inline-block; max-width:100%; }

/* Color list styling with arrows */
.color-list { list-style: none; padding: 0; margin: 16px 0; }
.color-list li { display: inline-block; margin-right: 1rem; margin-bottom: 0.8rem; padding: 6px 12px; background: var(--soft-blue); border-radius: 6px; border: 1px solid var(--medium-blue); }
.color-badge { display: inline-block; width: 20px; height: 20px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.2); vertical-align: middle; margin-right: 6px; }
.rarity-arrow { display: inline-block; font-size: 14px; margin-left: 4px; font-weight: bold; }
.rarity-arrow.green { color: #0b8a0b; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; }
.rarity-arrow.red { color: #f44336; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; }

/* Section headers */
.section-header { margin-top: 32px; margin-bottom: 16px; color: var(--dark-blue); font-size: 20px; font-weight: 700; border-bottom: 2px solid var(--medium-blue); padding-bottom: 8px; }

/* Links section */
.buy-links { margin: 20px 0; }
.buy-links a { display: inline-block; margin-right: 16px; margin-bottom: 8px; padding: 10px 20px; background: var(--medium-blue); color: white; text-decoration: none; border-radius: 6px; font-weight: 600; transition: background 0.2s; }
.buy-links a:hover { background: var(--dark-blue); }

@media (max-width: 900px) { 
  .profile-grid { grid-template-columns: 1fr; } 
  .profile-right { order: -1; width:100%; }
  .gauge { position: static !important; width: auto; }
  .gauge svg { transform: none; max-width:100%; } 
}
.profile-bottom { margin-top: 18px; width: 100%; }
.profile-bottom .section-header { margin-top: 12px; }
/* Make profile-bottom span both grid columns */
.profile-grid .profile-bottom { grid-column: 1 / -1; }
</style>
{% endblock %}

{% block content %}
  <div class="profile-grid">
    <div class="profile-left">
      <h1>{{ gem_name }}</h1>
      <p style="font-size: 16px; color: var(--dark-gray); margin-bottom: 24px;"><strong>Mineral Group:</strong> {{ mineral_group or 'Unknown' }}</p>

      <h2 class="section-header">Key Properties</h2>
      <table class="info-table">
        <tr>
          <th>Property</th>
          <th>Value</th>
        </tr>
        <tr>
          <td><strong>Mohs Hardness</strong></td>
          <td>{% if hardness_val and hardness_val|float > 0 %}{{ hardness_val|round(2) }}{% if hardness_str %} ({{ hardness_str }}){% endif %}{% else %}Unknown{% endif %}</td>
        </tr>
        <tr>
          <td><strong>Typical Size</strong></td>
          <td>{{ typical_size or 'Unknown' }}</td>
        </tr>
        <tr>
          <td><strong>Typical Price Range</strong></td>
          <td>{{ typical_price or 'Unknown' }}</td>
        </tr>
        <tr>
          <td><strong>Rarity Level</strong></td>
          <td>{{ rarity_label or 'Unknown' }}</td>
        </tr>
        <tr>
          <td><strong>Availability Level</strong></td>
          <td>{{ availability_label or 'Unknown' }}</td>
        </tr>
        {% if availability_driver %}
        <tr>
          <td><strong>Availability Driver</strong></td>
          <td>{{ availability_driver }}</td>
        </tr>
        {% endif %}
        <tr>
          <td><strong>Investment Appropriateness</strong></td>
          <td>{{ investment_label or 'Unknown' }}</td>
        </tr>
      </table>

      <h2 class="section-header">Detailed Descriptions</h2>
      <p><strong>Rarity Description:</strong> {{ rarity_description or 'No description available.' }}</p>
      <p><strong>Availability Description:</strong> {{ availability_description or 'No description available.' }}</p>
      <p><strong>Investment Description:</strong> {{ investment_description or 'No description available.' }}</p>
  </div>

      <div class="profile-right">
      <div class="gauge">
        <!-- Ranking tier (prominent) -->
        {% if tier %}
        <div style="text-align: center;">
          <div class="tier-indicator {{ tier_color|default('')|lower() }}">{{ tier }}</div>
        </div>
        {% endif %}
        <!-- Overall composite score shown above the gauge -->
        <div class="gauge-number">{{ composite }}</div>
        <!-- Simple semicircle gauge using SVG -->
        {% set pct = (composite or 0) %}
        <svg viewBox="0 -12 200 124" width="300" height="160" aria-hidden="true" style="overflow:visible;">
          <defs>
            <linearGradient id="grad" x1="0%" x2="100%">
              <stop offset="0%" stop-color="#f44336" />
              <stop offset="50%" stop-color="#ffec3d" />
              <stop offset="100%" stop-color="#0b8a0b" />
            </linearGradient>
          </defs>
          <path d="M10 90 A90 90 0 0 1 190 90" fill="none" stroke="#e8e8e8" stroke-width="16" />
          <path d="M10 90 A90 90 0 0 1 190 90" fill="none" stroke="url(#grad)" stroke-width="16"
                stroke-dasharray="283" stroke-dashoffset="{{ 283 - (283 * (pct/100.0)) }}" stroke-linecap="round" />
        </svg>

        <div class="components">
          <h4>Score Components</h4>
          {% for label, val in composite_components.items() %}
            <div class="comp-row">
              <div class="comp-label">{{ label.replace('_',' ').replace('geological','Geo').replace('market','Mkt').replace('investment','Invest').replace('appropriateness','Appr') }}</div>
              <div class="comp-bar"><div class="comp-fill" style="width: {{ val }}%"></div></div>
              <div class="comp-value">{{ val }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="profile-bottom">
    {% if colors %}
      <h2 class="section-header">Colors</h2>
      <ul class="color-list">
        {% for c in colors %}
          <li>
            <span class="color-badge" style="background:{{ c.hex or '#ccc' }};"></span>
            <strong>{{ c.color }}</strong>
            {% if c.rarity %}
              {% if c.rarity == 'Very Rare' %}
                <span class="rarity-arrow green">⬆⬆</span>
              {% elif c.rarity == 'Rare' %}
                <span class="rarity-arrow green">⬆</span>
              {% elif c.rarity == 'Uncommon' %}
                <span class="rarity-arrow red">⬇</span>
              {% elif c.rarity == 'Common' %}
                <span class="rarity-arrow red">⬇⬇</span>
              {% endif %}
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    <h2 class="section-header">Buy This Gem</h2>
    <div class="buy-links">
      <a href="https://www.gemrockauctions.com/search?query={{ gem_name | urlencode }}" target="_blank" rel="noopener noreferrer" referrerpolicy="no-referrer">Buy on Gem Rock Auctions</a>
      <a href="https://www.bestingems.com/listing/buy-gemstones-online/?filter=gemsname:{{ gem_name | urlencode }}" target="_blank" rel="noopener noreferrer" referrerpolicy="no-referrer">Buy on Best In Gems</a>
    </div>

    <h2 class="section-header">Investment Ranking Calculation</h2>
    <p>The composite score of <strong>{{ composite }}</strong> is calculated using a weighted formula:</p>
    <ul style="line-height: 1.8;">
      <li><strong>Geological Rarity (25%):</strong> {{ composite_components.geological_rarity }} points</li>
      <li><strong>Market Availability (25%):</strong> {{ composite_components.market_availability }} points</li>
      <li><strong>Investment Appropriateness (25%):</strong> {{ composite_components.investment_appropriateness }} points</li>
      <li><strong>Hardness (12.5%):</strong> {{ composite_components.hardness }} points</li>
      <li><strong>Price Range (12.5%):</strong> {{ composite_components.price }} points</li>
    </ul>
    <p><strong>Formula:</strong> ({{ composite_components.geological_rarity }} × 0.25) + ({{ composite_components.market_availability }} × 0.25) + ({{ composite_components.investment_appropriateness }} × 0.25) + ({{ composite_components.hardness }} × 0.125) + ({{ composite_components.price }} × 0.125) = <strong>{{ composite }}</strong></p>

    <h2 class="section-header">Current Listings</h2>
    {% if show_listings %}
      <div id="listings-wrapper">
      <table id="current-listings" class="info-table">
        <colgroup>
          <col style="width: 80px;">
          <col style="width: 90px;">
          <col style="width: 110px;">
          <col>
          <col style="width: 150px;">
        </colgroup>
        <thead>
          <tr>
            <th>Listing ID</th>
            <th>Carat Weight</th>
            <th>Price (USD)</th>
            <th>Title</th>
            <th>Seller</th>
          </tr>
        </thead>
        <tbody>
          {% if current_listings and current_listings|length > 0 %}
            {% for item in current_listings %}
              <tr>
                <td class="col-id">{{ item.listing_id or item.id or '' }}</td>
                <td class="col-weight">{{ item.carat_weight or item.weight or '' }}</td>
                <td class="col-price">{{ item.price or '' }}</td>
                <td class="col-title">{% if item.title_url %}<a class="listing-title-link" href="{{ item.title_url }}" target="_blank" rel="noopener noreferrer" referrerpolicy="no-referrer">{{ item.title or item.listing_title or 'View' }}</a>{% else %}{{ item.title or item.listing_title or '' }}{% endif %}</td>
                <td class="col-seller">{% if item.seller_url %}<a href="{{ item.seller_url }}" target="_blank" rel="noopener noreferrer" referrerpolicy="no-referrer">{{ item.seller or item.seller_nickname or 'Seller' }}</a>{% else %}{{ item.seller or item.seller_nickname or '' }}{% endif %}</td>
              </tr>
            {% endfor %}
          {% else %}
            {% if not show_listings %}
                <tr><td colspan="5" style="text-align:center;">Please sign in to view current listings.</td></tr>
            {% else %}
                <tr><td colspan="5" style="text-align:center;">Loading current listings&hellip;</td></tr>
            {% endif %}
          {% endif %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="no-listings-cta" style="padding:8px 0;">Please sign in to view current listings.</div>
    {% endif %}
  </div>
  </div>

{% endblock %}



{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const tbody = document.querySelector('#current-listings tbody');
  if (!tbody) return;

  const params = new URLSearchParams();
  {% if gem_type_id %}
  params.set('gem_type_id', '{{ gem_type_id }}');
  {% else %}
  params.set('gem', '{{ gem_name | escape }}');
  {% endif %}
  {% if current_user and current_user.google_id %}
  params.set('google_user_id', '{{ current_user.google_id }}');
  {% endif %}

  // Use same-origin endpoint to avoid exposing upstream keys in browser
  const url = '/api/v1/listings-view/?' + params.toString();

  function renderItems(items) {
    items.forEach(it => {
      if (!('listing_id' in it) && ('id' in it)) it.listing_id = it.id;
      if (!('carat_weight' in it) && ('weight' in it)) it.carat_weight = it.weight;
      if (!('title' in it) && ('listing_title' in it)) it.title = it.listing_title;
      if (!('title_url' in it) && ('listing_url' in it)) it.title_url = it.listing_url;
      if (!('seller' in it) && ('seller_nickname' in it)) it.seller = it.seller_nickname;
      if (!('seller_url' in it) && ('seller_profile' in it)) it.seller_url = it.seller_profile;
    });

    if (items.length > 0) console.debug('first listing item', items[0]);
    tbody.innerHTML = '';
    if (!items.length) {
      console.debug('No listings found.');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No listings found.</td></tr>';
      return;
    }
    items.forEach(item => {
      const tr = document.createElement('tr');
      const id = document.createElement('td'); id.textContent = item.listing_id || '';
      const w = document.createElement('td'); w.textContent = item.carat_weight != null ? item.carat_weight : '';
      const p = document.createElement('td');
      let priceText = '';
      if (item.price != null) {
        if (typeof item.price === 'number') {
          priceText = '$' + item.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
        } else if (typeof item.price === 'string') {
          priceText = item.price.trim();
          if (!priceText.startsWith('$') && /^\d/.test(priceText)) {
            const pv = parseFloat(priceText.replace(/[, ]/g, ''));
            if (!Number.isNaN(pv)) {
              priceText = '$' + pv.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            }
          }
        }
      }
      p.textContent = priceText;
      const t = document.createElement('td');
      // ensure product URL exists or synthesize it
      if (!item.title_url && item.title && item.listing_id) {
        const slug = ('' + item.title).toLowerCase().replace(/[^\w\s-]/g, '').replace(/[\s_]+/g, '-');
        item.title_url = 'https://www.gemrockauctions.com/products/' + slug + '-' + item.listing_id;
      }
      if (item.title_url) {
        const a = document.createElement('a'); a.href = item.title_url; a.target = '_blank'; a.rel='noopener noreferrer'; a.setAttribute('referrerpolicy','no-referrer'); a.textContent = item.title || 'View'; a.classList.add('listing-title-link'); t.appendChild(a);
      } else {
        t.textContent = item.title || '';
      }
      const s = document.createElement('td');
      if (!item.seller_url && item.seller) {
        const sellerSlug = ('' + item.seller).toLowerCase().replace(/[^\w\s-]/g, '').replace(/[\s_]+/g, '-');
        item.seller_url = 'https://www.gemrockauctions.com/stores/' + sellerSlug;
      }
      if (item.seller_url) {
        const a2 = document.createElement('a'); a2.href = item.seller_url; a2.target = '_blank'; a2.rel='noopener noreferrer'; a2.setAttribute('referrerpolicy','no-referrer'); a2.textContent = item.seller || 'Seller'; s.appendChild(a2);
      } else {
        s.textContent = item.seller || '';
      }
      tr.appendChild(id); tr.appendChild(w); tr.appendChild(p); tr.appendChild(t); tr.appendChild(s);
      tbody.appendChild(tr);
    });
  }

  // If server provided items in page (server-side fetch), use them; else fetch from same-origin
  {% if current_listings is defined %}
  const serverItems = {{ current_listings|tojson|safe }};
  {% else %}
  const serverItems = null;
  {% endif %}
  const showListings = {{ 'true' if show_listings else 'false' }};
  if (serverItems && Array.isArray(serverItems) && serverItems.length && showListings) {
    renderItems(serverItems);
  } else {
    // fetch from same-origin API and render items (only if allowed to show listings)
    if (showListings) {
    fetch(url, { credentials: 'same-origin' })
      .then(r => r.json())
      .then(data => {
        const list = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
        if (Array.isArray(list) && list.length) {
          renderItems(list);
        } else {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No listings found.</td></tr>';
        }
      }).catch(err => {
        console.error('Failed to fetch listings', err);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Failed to load listings.</td></tr>';
      });
    } else {
      // not allowed to show listings, show sign in message if not already present
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Please sign in to view current listings.</td></tr>';
    }
  }
});
</script>
{% endblock %}
