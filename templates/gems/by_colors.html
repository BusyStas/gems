{% extends "base.html" %}

{% block title %}{{ title }} - {{ config.SITE_NAME }}{% endblock %}

{% block meta_description %}{{ description }}{% endblock %}

{% block extra_css %}
<style>
.color-palette {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: var(--spacing-md);
}

.color-swatch {
    /* doubled size: make the swatch noticeably larger and keep the wrapper
       borderless so the diamond SVG itself carries the visible border */
    width: 96px;
    height: 96px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: transparent;
    border: none;
    box-shadow: none;
}

.color-swatch.active {
    outline: 3px solid var(--pale-blue);
    transform: translateY(-2px);
}

.color-label {
    font-size: 0.85rem;
    margin-left: 0.5rem;
}

.color-swatch .color-name {
    display: block;
    font-size: 0.65rem;
    text-align: center;
    margin-top: 4px;
    color: var(--dark-gray);
}

.mini-swatch {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid rgba(0,0,0,0.35);
    vertical-align: middle;
    margin-right: 0.35rem;
    box-shadow: 0 0 0 2px rgba(255,255,255,0.6) inset, 0 1px 2px rgba(0,0,0,0.08);
}

.gem-list {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.gem-item {
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--light-gray);
}

.gem-colors {
    font-size: 0.9rem;
}

.gem-color-chip {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    margin-right: 0.4rem;
    border-radius: 12px;
    background: var(--pale-blue);
    color: var(--dark-gray);
    text-decoration: none;
}

.rarity-very-rare { color: #0a8a0a; font-weight: 600; }
.rarity-rare { color: #0a8a0a; }
.rarity-uncommon { color: #c62828; }
.rarity-common { color: #c62828; }

.rarity-arrows { margin-left: 0.35rem; font-size: 0.85rem; }

.hidden { display: none !important; }
</style>
{% endblock %}

{% block content %}
<section class="hero-section">
    <h1>{{ title }}</h1>
    <p>{{ description }}</p>
</section>

<section class="content-section">
    <h2>Colors</h2>
    <div class="color-palette" id="colorPalette">
        {% for c in palette %}
        <div class="color-swatch" tabindex="0" role="button" title="{{ c.color }} (primary) - contrast: {{ c.hex|contrast_label }}" data-color="{{ c.color }}" aria-label="{{ c.color }} (contrast: {{ c.hex|contrast_label }})">
            <!-- Inline gem SVG filled with the primary color -->
            <svg class="gem-icon" viewBox="0 0 24 24" width="96" height="96" aria-hidden="true" focusable="false">
                <!-- let CSS add a stroke so the diamond itself has a visible border -->
                <path d="M12 2 L20 8 L16 20 L8 20 L4 8 Z" fill="{{ c.hex }}" />
            </svg>
            <span class="color-name">{{ c.color }}</span>
        </div>
        {% endfor %}
        <button id="clearFilters" class="gem-color-chip" style="margin-left: 0.5rem;">Clear filters</button>
    </div>
</section>

<section class="content-section">
    <h2>Gem Types</h2>
    <ul class="gem-list" id="gemList">
        {% for gem in gems %}
        <li class="gem-item" data-colors="{% for col in gem.colors %}{{ col.color }}{% if not loop.last %};{% endif %}{% endfor %}">
            <div class="gem-line">
                <a class="gem-name" href="{{ search_base_url }}{{ gem.name|urlencode }}" target="_blank" rel="noopener noreferrer" title="{{ gem.mineral_group }}">{{ gem.name }}</a>
                {% if gem.colors %}
                <span class="sep">:</span>
                <div class="gem-colors">
                    {% for col in gem.colors %}
                        {# Build Gem Rock Auctions search URL using query parameter: "color gem" #}
                        {% set q = (col.color ~ ' ' ~ gem.name) | urlencode %}
                        {% set gra_url = 'https://www.gemrockauctions.com/search?query=' ~ q %}
                        <a class="color-pill" href="{{ gra_url }}" target="_blank" rel="noopener noreferrer" style="background: {{ col.hex }}; color: {{ col.hex|contrast_fg }};" aria-label="{{ col.color }} ({{ col.rarity or 'rarity unknown' }}) - contrast: {{ col.hex|contrast_label }}">
                            <span class="pill-name">{{ col.color }}</span>
                            {% if col.rarity %}
                                {% set r = col.rarity|lower %}
                                {% if r == 'very rare' %}
                                    <span class="rarity-arrows"><span class="rarity-indicator rarity-very-rare">&#9650;&#9650;</span></span>
                                {% elif r == 'rare' %}
                                    <span class="rarity-arrows"><span class="rarity-indicator rarity-rare">&#9650;</span></span>
                                {% elif r == 'uncommon' %}
                                    <span class="rarity-arrows"><span class="rarity-indicator rarity-uncommon">&#9660;</span></span>
                                {% elif r == 'common' %}
                                    <span class="rarity-arrows"><span class="rarity-indicator rarity-common">&#9660;&#9660;</span></span>
                                {% else %}
                                    <span class="rarity-arrows"><span class="rarity-indicator">&nbsp;</span></span>
                                {% endif %}
                            {% endif %}
                        </a>
                        {% if not loop.last %} {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </li>
        {% endfor %}
    </ul>
</section>

<script>
// Client-side filtering by color
(function(){
    const palette = document.getElementById('colorPalette');
    const swatches = palette ? palette.querySelectorAll('.color-swatch') : [];
    const gemList = document.getElementById('gemList');
    const gems = gemList ? gemList.querySelectorAll('.gem-item') : [];
    const clearBtn = document.getElementById('clearFilters');

    function clearActive() {
        swatches.forEach(s => s.classList.remove('active'));
    }

    function filterByColor(color) {
        gems.forEach(g => {
            const colors = (g.getAttribute('data-colors') || '').split(';').map(s => s.trim()).filter(Boolean);
            if (!color) {
                g.classList.remove('hidden');
                return;
            }
            if (colors.indexOf(color) >= 0) {
                g.classList.remove('hidden');
            } else {
                g.classList.add('hidden');
            }
        });
    }

    swatches.forEach(s => {
        s.addEventListener('click', function(){
            const color = this.getAttribute('data-color');
            clearActive();
            this.classList.add('active');
            filterByColor(color);
        });
        s.addEventListener('keydown', function(e){
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });

    if (clearBtn) {
        clearBtn.addEventListener('click', function(){
            clearActive();
            filterByColor('');
        });
    }
})();
</script>

{% endblock %}
